<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Billar - HLS</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #121212;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* === SETUP VIEW === */
        #setup-view {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .setup-container {
            background: #1e1e1e;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 95%;
        }

        .setup-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #aaa;
            font-weight: 500;
            font-size: 1.1em;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 14px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 6px;
            color: #fff;
            font-size: 1.2em;
        }

        .player-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .player-input {
            display: grid;
            grid-template-columns: 120px 1fr;
            align-items: center;
            gap: 15px;
        }

        .player-input label {
            color: #ccc;
            font-size: 1em;
            font-weight: 500;
            text-align: right;
        }

        .player-input input {
            padding: 12px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
            color: #fff;
            font-size: 1em;
            width: 100%;
        }

        .btn-start {
            width: 100%;
            padding: 18px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 25px;
            transition: 0.3s;
        }

        .btn-start:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* === GAME VIEW === */
        .game-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Left side: scoreboard + video */
        .left-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }


        /* Scoreboard superior */
        .scoreboard {
            background: #000;
            padding: 12px 15px;
            display: flex;
            justify-content: center;
            gap: 18px;
            border-bottom: 3px solid #007bff;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .score-display {
            text-align: center;
            background: #1a1a1a;
            padding: 20px 35px;
            border-radius: 12px;
            border: 5px solid #333;
            min-width: 200px;
            cursor: pointer;
            transition: 0.2s;
        }

        .score-display:hover {
            border-color: #007bff;
            transform: scale(1.03);
        }

        .score-display.active {
            border-color: #28a745;
            background: #1e3a1e;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
        }

        .score-val {
            font-size: 4.5em;
            font-weight: bold;
            color: #fff;
            line-height: 1;
            margin-bottom: 8px;
        }

        .score-avg {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 10px;
            border-top: 1px solid #444;
            padding-top: 8px;
            line-height: 1.5;
        }

        .score-avg-num {
            color: #4CAF50;
            font-weight: 600;
            font-size: 1.1em;
        }

        .score-lbl {
            font-size: 0.8em;
            color: #888;
            margin-top: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Main content */
        /* Video section */
        .video-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: #0a0a0a;
            min-height: 0;
        }

        .video-wrapper {
            flex: 1;
            background: #000;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            min-height: 0;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        video:fullscreen {
            object-fit: contain;
        }

        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.95em;
            z-index: 10;
            pointer-events: none;
        }

        .badge-live {
            background: #e74c3c;
            color: white;
        }

        .badge-dvr {
            background: #3498db;
            color: white;
        }

        .no-signal {
            position: absolute;
            inset: 0;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #666;
            z-index: 5;
        }

        /* Panel lateral completo */
        .control-panel {
            width: 350px;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-section {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.1em;
            text-align: center;
        }

        .score-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .btn-score {
            padding: 35px;
            font-size: 3.2em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            transition: 0.2s;
        }

        .btn-score:active {
            transform: scale(0.95);
        }

        .btn-number {
            background: #3498db;
        }

        .btn-number:hover {
            background: #2980b9;
        }

        .btn-minus {
            background: #e74c3c;
        }

        .btn-minus:hover {
            background: #c0392b;
        }

        .btn-plus {
            background: #27ae60;
        }

        .btn-plus:hover {
            background: #229954;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
            margin-top: auto;
        }

        .btn-action {
            padding: 14px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn-record {
            background: #d35400;
            color: white;
        }

        .btn-record:hover {
            background: #ba4a00;
        }

        .btn-golive {
            background: #e74c3c;
            color: white;
        }

        .btn-back {
            background: #34495e;
            color: white;
        }

        #debugLog {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.9);
            color: lime;
            font-family: monospace;
            font-size: 11px;
            overflow-y: scroll;
            padding: 8px;
            pointer-events: none;
            display: none;
            z-index: 100;
        }
    </style>
</head>

<body>
    <!-- SETUP VIEW -->
    <div id="setup-view">
        <div class="setup-container">
            <h1>üé± Configurar Partida</h1>
            <div class="form-group">
                <label for="playerCount">N√∫mero de Jugadores (1-8):</label>
                <input type="number" id="playerCount" min="1" max="8" value="2" onchange="generatePlayerInputs()">
            </div>
            <div class="form-group">
                <label>Nombres de Jugadores (opcional):</label>
                <div id="playerInputs" class="player-inputs"></div>
            </div>
            <button class="btn-start" onclick="startGame()">üéÆ Iniciar Partida</button>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view" class="hidden">
        <div class="game-container">
            <!-- Left Section: Scoreboard + Video -->
            <div class="left-section">
                <!-- Scoreboard -->
                <div id="scoreboard" class="scoreboard"></div>

                <!-- Video Section -->
                <div class="video-section">
                    <div class="video-wrapper">
                        <div id="noSignal" class="no-signal">
                            <h2>ESPERANDO GRABACI√ìN</h2>
                            <p id="statusMsg">Listo</p>
                        </div>
                        <video id="video" controls muted playsinline controlsList="nodownload"></video>
                        <div id="badgeLive" class="status-badge badge-live hidden">‚óè EN VIVO</div>
                        <div id="badgeDVR" class="status-badge badge-dvr hidden">‚Ü∫ REPRODUCCI√ìN</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Controls (Full Height) -->
            <div class="control-panel">
                <div class="control-section">
                    <h3>Puntos R√°pidos</h3>
                    <div class="score-buttons">
                        <button class="btn-score btn-number" onclick="addPoints(1)">1</button>
                        <button class="btn-score btn-number" onclick="addPoints(2)">2</button>
                        <button class="btn-score btn-number" onclick="addPoints(3)">3</button>
                        <button class="btn-score btn-number" onclick="addPoints(4)">4</button>
                        <button class="btn-score btn-minus" onclick="addPoints(-1)">-</button>
                        <button class="btn-score btn-plus" onclick="addPoints(1)">+</button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="btnRecord" class="btn-action btn-record" onclick="toggleRecording()">Grabar</button>
                    <button class="btn-action btn-golive" onclick="goLive()">Ir a En Vivo</button>
                    <button class="btn-action btn-back" onclick="backToSetup()">Nueva Partida</button>
                </div>
            </div>
        </div>
        <div id="debugLog"></div>
    </div>

    <script>
        // === GLOBAL STATE ===
        let gameConfig = { playerCount: 2, players: [] };
        let activePlayerId = null;
        let currentServerScores = {};
        let playerAttempts = {};
        let currentPlayerIndex = 0; // √çndice del jugador actual en secuencia

        const video = document.getElementById('video');
        const hlsSource = '/hls/stream.m3u8';
        let hls = null;
        let recording = false;
        let eventHistory = [];
        let startTime = 0;

        // === SETUP LOGIC ===
        function generatePlayerInputs() {
            const count = parseInt(document.getElementById('playerCount').value);
            const container = document.getElementById('playerInputs');
            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'player-input';
                div.innerHTML = `
                    <label>Jugador ${i}:</label>
                    <input type="text" id="player${i}Name" placeholder="Jugador ${i}">
                `;
                container.appendChild(div);
            }
        }

        function startGame() {
            const count = parseInt(document.getElementById('playerCount').value);
            gameConfig.playerCount = count;
            gameConfig.players = [];

            for (let i = 1; i <= count; i++) {
                const nameInput = document.getElementById(`player${i}Name`);
                const name = nameInput.value.trim() || `Jugador ${i}`;
                gameConfig.players.push({ id: `player_${i - 1}`, name: name });
            }

            generateGameUI();
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');

            initPlayer();
            setInterval(checkStatus, 3000);
            setInterval(fetchHistory, 5000);
            log("Sistema iniciado con " + count + " jugadores");
        }

        function generateGameUI() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.innerHTML = '';
            currentServerScores = {};
            playerAttempts = {};
            currentPlayerIndex = 0;

            gameConfig.players.forEach((player, idx) => {
                currentServerScores[player.id] = 0;
                playerAttempts[player.id] = 0;

                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'score-display';
                scoreDiv.id = `score-card-${player.id}`;
                scoreDiv.onclick = () => selectPlayer(idx);
                scoreDiv.innerHTML = `
                    <div class="score-val" id="disp-${player.id}">0</div>
                    <div class="score-avg" id="avg-${player.id}">
                        Prom: <span class="score-avg-num">0.0</span><br>
                        <small>(0/0)</small>
                    </div>
                    <div class="score-lbl">${player.name}</div>
                `;
                scoreboard.appendChild(scoreDiv);
            });

            // Activar primer jugador
            if (gameConfig.players.length > 0) {
                activePlayerId = gameConfig.players[0].id;
                const firstCard = document.getElementById(`score-card-${activePlayerId}`);
                if (firstCard) firstCard.classList.add('active');
            }
        }

        function selectPlayer(playerIndex) {
            const playerId = gameConfig.players[playerIndex].id;

            // Incrementar intentos del jugador anterior si cambi√≥
            if (activePlayerId && activePlayerId !== playerId) {
                playerAttempts[activePlayerId]++;
                updatePlayerAverage(activePlayerId);
            }

            activePlayerId = playerId;
            currentPlayerIndex = playerIndex;

            // Actualizar estilos
            document.querySelectorAll('.score-display').forEach(el => {
                el.classList.remove('active');
            });
            const card = document.getElementById(`score-card-${playerId}`);
            if (card) card.classList.add('active');
        }

        function updatePlayerStates() {
            gameConfig.players.forEach((player, idx) => {
                const card = document.getElementById(`score-card-${player.id}`);
                if (!card) return;

                card.classList.remove('active', 'disabled');

                if (idx === currentPlayerIndex) {
                    card.classList.add('active');
                    activePlayerId = player.id;
                } else {
                    card.classList.add('disabled');
                }
            });
        }

        function updatePlayerAverage(playerId) {
            const avgEl = document.getElementById(`avg-${playerId}`);
            if (!avgEl) return;

            const points = currentServerScores[playerId] || 0;
            const attempts = playerAttempts[playerId] || 0;
            const avg = attempts > 0 ? (points / attempts).toFixed(1) : '0.0';

            avgEl.innerHTML = `
                Prom: <span class="score-avg-num">${avg}</span><br>
                <small>(${points}/${attempts})</small>
            `;
        }

        function addPoints(amount) {
            if (!activePlayerId) {
                alert('Selecciona un jugador primero');
                return;
            }

            const el = document.getElementById(`disp-${activePlayerId}`);
            if (!el) return;

            let val = parseInt(el.innerText);
            val += amount;
            if (val < 0) val = 0;
            el.innerText = val;

            const action = amount > 0 ? 'add' : 'subtract';
            const times = Math.abs(amount);

            for (let i = 0; i < times; i++) {
                fetch('/update_score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player: activePlayerId, action })
                }).then(r => r.json()).then(data => {
                    currentServerScores = data.scores;
                    if (isLiveMode()) updateScoreboard(currentServerScores);
                });
            }
        }

        function backToSetup() {
            if (recording && !confirm('¬øDetener grabaci√≥n y comenzar nueva partida?')) return;
            if (recording) {
                fetch('/stop_recording', { method: 'POST' });
                recording = false;
            }
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('setup-view').classList.remove('hidden');
        }

        // === PLAYER LOGIC ===
        function log(msg) {
            const dbg = document.getElementById('debugLog');
            dbg.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            dbg.scrollTop = dbg.scrollHeight;
        }

        function initPlayer() {
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferLength: 30,
                    liveSyncDurationCount: 2,
                    liveMaxLatencyDurationCount: 6,
                    manifestLoadingTimeOut: 10000,
                    manifestLoadingMaxRetry: 5,
                });
                hls.attachMedia(video);
                hls.on(Hls.Events.MEDIA_ATTACHED, () => log("HLS Attached"));
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    log("Manifest Parsed");
                    video.play().catch(e => log("Autoplay fail: " + e));
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        log(`Error Fatal: ${data.type}`);
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                            case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                            default: hls.destroy(); break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = hlsSource;
                video.addEventListener('canplay', () => video.play());
            }
        }

        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                if (data.recording && !recording) {
                    log("Servidor grabando");
                    startPlayerUI();
                    recording = true;
                    startTime = data.start_time;
                    updateBtnUI(true);
                } else if (!data.recording && recording) {
                    stopPlayerUI();
                    recording = false;
                    updateBtnUI(false);
                }
                currentServerScores = data.current_scores;
                if (isLiveMode()) updateScoreboard(currentServerScores);
            } catch (e) { }
        }

        async function fetchHistory() {
            if (!recording) return;
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                eventHistory = data.events;
                startTime = data.start_time;
            } catch (e) { }
        }

        function isLiveMode() {
            if (!recording) return true;
            if (video.paused) return false;
            return (video.duration - video.currentTime) < 6.0;
        }

        video.addEventListener('timeupdate', () => {
            if (!recording || eventHistory.length === 0) return;
            const live = isLiveMode();
            updateBadges(live);
            if (live) return;

            const vTime = video.currentTime;
            let foundScores = null;
            for (let i = eventHistory.length - 1; i >= 0; i--) {
                const eventRelativeTime = eventHistory[i].timestamp - startTime;
                if (eventRelativeTime <= vTime) {
                    foundScores = eventHistory[i].scores;
                    break;
                }
            }
            if (foundScores) updateScoreboard(foundScores);
            else if (eventHistory.length > 0) updateScoreboard(eventHistory[0].scores);
        });

        async function toggleRecording() {
            if (recording) {
                if (!confirm("¬øParar grabaci√≥n?")) return;
                await fetch('/stop_recording', { method: 'POST' });
                stopPlayerUI();
            } else {
                updateStatusMsg("Iniciando FFmpeg...");
                await fetch('/start_recording', { method: 'POST' });
            }
        }

        function startPlayerUI() {
            document.getElementById('noSignal').classList.add('hidden');
            hls.loadSource(hlsSource);
            hls.startLoad();
            video.muted = true;
            video.play().catch(e => log("Autoplay blocked: " + e));
        }

        function stopPlayerUI() {
            document.getElementById('noSignal').classList.remove('hidden');
            updateStatusMsg("Listo");
            if (hls) hls.stopLoad();
            document.getElementById('badgeLive').classList.add('hidden');
            document.getElementById('badgeDVR').classList.add('hidden');
        }

        function goLive() {
            if (recording) {
                video.currentTime = video.duration - 0.5;
                video.play();
            }
        }

        function updateScoreboard(scores) {
            for (const [k, v] of Object.entries(scores)) {
                const el = document.getElementById(`disp-${k}`);
                if (el) {
                    el.innerText = v;
                    currentServerScores[k] = v;
                    updatePlayerAverage(k);
                }
            }
        }

        function updateBtnUI(isRec) {
            const btn = document.getElementById('btnRecord');
            if (isRec) {
                btn.innerText = "Detener";
                btn.className = "btn-action btn-golive";
            } else {
                btn.innerText = "Grabar";
                btn.className = "btn-action btn-record";
            }
        }

        function updateBadges(isLive) {
            const bLive = document.getElementById('badgeLive');
            const bDVR = document.getElementById('badgeDVR');
            if (isLive) {
                bLive.classList.remove('hidden');
                bDVR.classList.add('hidden');
            } else {
                bLive.classList.add('hidden');
                bDVR.classList.remove('hidden');
            }
        }

        function updateStatusMsg(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        document.addEventListener('DOMContentLoaded', () => {
            generatePlayerInputs();
        });
    </script>
</body>

</html>