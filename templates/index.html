<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Billar - HLS</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #121212;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        /* === SETUP VIEW === */
        #setup-view {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .setup-container {
            background: #1e1e1e;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
        }

        .setup-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-weight: 500;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 12px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 6px;
            color: #fff;
            font-size: 1.1em;
        }

        .player-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .player-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-input label {
            min-width: 90px;
            color: #888;
            font-size: 0.9em;
        }

        .player-input input {
            flex: 1;
            padding: 10px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
            color: #fff;
        }

        .btn-start {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.3s;
        }

        .btn-start:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* === GAME VIEW === */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .side-panel {
            width: 140px;
            background: #1e1e1e;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-right: 1px solid #333;
        }

        .side-panel.right {
            border-left: 1px solid #333;
            border-right: none;
        }

        .mesa-card {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #3d3d3d;
        }

        .mesa-title {
            font-size: 0.75em;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mesa-controls {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .btn-score {
            flex: 1;
            padding: 10px 0;
            font-size: 1.2em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            transition: 0.1s;
        }

        .btn-minus {
            background: #c0392b;
        }

        .btn-plus {
            background: #27ae60;
        }

        .center-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .scoreboard {
            background: #000;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-bottom: 2px solid #007bff;
            flex-wrap: wrap;
        }

        .score-display {
            text-align: center;
            background: #1a1a1a;
            padding: 5px 12px;
            border-radius: 4px;
            border: 1px solid #333;
            min-width: 70px;
        }

        .score-val {
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
            line-height: 1;
        }

        .score-lbl {
            font-size: 0.65em;
            color: #888;
            margin-top: 2px;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .video-wrapper {
            flex: 1;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            max-height: 80vh;
        }

        .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            z-index: 10;
            pointer-events: none;
        }

        .badge-live {
            background: #e74c3c;
            color: white;
        }

        .badge-dvr {
            background: #3498db;
            color: white;
        }

        .controls-bar {
            background: #1e1e1e;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-main {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .btn-record {
            background: #d35400;
            color: white;
        }

        .btn-golive {
            background: #e74c3c;
            color: white;
        }

        .btn-reset {
            background: #7f8c8d;
            color: white;
        }

        .btn-back {
            background: #34495e;
            color: white;
        }

        .no-signal {
            position: absolute;
            inset: 0;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #666;
            z-index: 5;
        }

        #debugLog {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            color: lime;
            font-family: monospace;
            font-size: 10px;
            overflow-y: scroll;
            padding: 5px;
            pointer-events: none;
            display: none;
        }
    </style>
</head>

<body>
    <!-- SETUP VIEW -->
    <div id="setup-view">
        <div class="setup-container">
            <h1>üé± Configurar Partida</h1>
            <div class="form-group">
                <label for="playerCount">N√∫mero de Jugadores (1-8):</label>
                <input type="number" id="playerCount" min="1" max="8" value="2" onchange="generatePlayerInputs()">
            </div>
            <div class="form-group">
                <label>Nombres de Jugadores (opcional):</label>
                <div id="playerInputs" class="player-inputs"></div>
            </div>
            <button class="btn-start" onclick="startGame()">üéÆ Iniciar Partida</button>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view" class="hidden">
        <div class="main-container">
            <!-- Panel Izquierdo -->
            <div id="leftPanel" class="side-panel"></div>

            <!-- Centro -->
            <div class="center-area">
                <div id="scoreboard" class="scoreboard"></div>

                <div class="video-wrapper">
                    <div id="noSignal" class="no-signal">
                        <h2>ESPERANDO GRABACI√ìN</h2>
                        <p id="statusMsg">Listo</p>
                    </div>
                    <video id="video" controls muted playsinline></video>
                    <div id="badgeLive" class="status-badge badge-live hidden">‚óè EN VIVO</div>
                    <div id="badgeDVR" class="status-badge badge-dvr hidden">‚Ü∫ REPRODUCCI√ìN</div>
                    <div id="debugLog"></div>
                </div>

                <div class="controls-bar">
                    <button id="btnRecord" class="btn-main btn-record" onclick="toggleRecording()">Grabar</button>
                    <button class="btn-main btn-golive" onclick="goLive()">Ir a En Vivo</button>
                    <button class="btn-main" onclick="toggleDebug()">Debug</button>
                    <button class="btn-main btn-reset" onclick="resetScores()">Reset 0</button>
                    <button class="btn-main btn-back" onclick="backToSetup()">‚Üê Configurar</button>
                </div>
            </div>

            <!-- Panel Derecho -->
            <div id="rightPanel" class="side-panel right"></div>
        </div>
    </div>

    <script>
        // === GLOBAL STATE ===
        let gameConfig = {
            playerCount: 2,
            players: []
        };
        let currentServerScores = {};

        const video = document.getElementById('video');
        const hlsSource = '/hls/stream.m3u8';
        let hls = null;
        let recording = false;
        let eventHistory = [];
        let startTime = 0;

        // === SETUP LOGIC ===
        function generatePlayerInputs() {
            const count = parseInt(document.getElementById('playerCount').value);
            const container = document.getElementById('playerInputs');
            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'player-input';
                div.innerHTML = `
                    <label>Jugador ${i}:</label>
                    <input type="text" id="player${i}Name" placeholder="Jugador ${i}">
                `;
                container.appendChild(div);
            }
        }

        function startGame() {
            const count = parseInt(document.getElementById('playerCount').value);
            gameConfig.playerCount = count;
            gameConfig.players = [];

            for (let i = 1; i <= count; i++) {
                const nameInput = document.getElementById(`player${i}Name`);
                const name = nameInput.value.trim() || `Jugador ${i}`;
                gameConfig.players.push({ id: `player_${i - 1}`, name: name });
            }

            // Generar UI din√°mica
            generateGameUI();

            // Cambiar vista
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');

            // Inicializar player
            initPlayer();
            setInterval(checkStatus, 3000);
            setInterval(fetchHistory, 5000);
            log("Sistema iniciado con " + count + " jugadores");
        }

        function generateGameUI() {
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const scoreboard = document.getElementById('scoreboard');

            leftPanel.innerHTML = '';
            rightPanel.innerHTML = '';
            scoreboard.innerHTML = '';

            // Inicializar scores en servidor
            currentServerScores = {};
            gameConfig.players.forEach(p => currentServerScores[p.id] = 0);

            // Dividir jugadores entre paneles
            const half = Math.ceil(gameConfig.players.length / 2);

            gameConfig.players.forEach((player, idx) => {
                // Panel lateral
                const card = document.createElement('div');
                card.className = 'mesa-card';
                card.innerHTML = `
                    <div class="mesa-title">${player.name}</div>
                    <div class="mesa-controls">
                        <button class="btn-score btn-minus" onclick="updateScore('${player.id}', 'subtract')">-</button>
                        <button class="btn-score btn-plus" onclick="updateScore('${player.id}', 'add')">+</button>
                    </div>
                `;

                if (idx < half) {
                    leftPanel.appendChild(card);
                } else {
                    rightPanel.appendChild(card);
                }

                // Marcador superior
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'score-display';
                scoreDiv.innerHTML = `
                    <div class="score-val" id="disp-${player.id}">0</div>
                    <div class="score-lbl" title="${player.name}">${player.name}</div>
                `;
                scoreboard.appendChild(scoreDiv);
            });
        }

        function backToSetup() {
            if (recording) {
                if (!confirm('¬øDetener grabaci√≥n y volver a configuraci√≥n?')) return;
                fetch('/stop_recording', { method: 'POST' });
                recording = false;
            }

            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('setup-view').classList.remove('hidden');
        }

        // === PLAYER LOGIC ===
        function log(msg) {
            const dbg = document.getElementById('debugLog');
            dbg.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            dbg.scrollTop = dbg.scrollHeight;
        }

        function toggleDebug() {
            const dbg = document.getElementById('debugLog');
            dbg.style.display = dbg.style.display === 'block' ? 'none' : 'block';
        }

        function initPlayer() {
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferLength: 30,
                    liveSyncDurationCount: 2,
                    liveMaxLatencyDurationCount: 6,
                    manifestLoadingTimeOut: 10000,
                    manifestLoadingMaxRetry: 5,
                });
                hls.attachMedia(video);

                hls.on(Hls.Events.MEDIA_ATTACHED, () => log("HLS Attached"));
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    log("Manifest Parsed");
                    video.play().catch(e => log("Autoplay fail: " + e));
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        log(`Error Fatal: ${data.type}`);
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                hls.recoverMediaError();
                                break;
                            default:
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = hlsSource;
                video.addEventListener('canplay', () => video.play());
            }
        }

        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                if (data.recording && !recording) {
                    log("Servidor grabando");
                    startPlayerUI();
                    recording = true;
                    startTime = data.start_time;
                    updateBtnUI(true);
                } else if (!data.recording && recording) {
                    stopPlayerUI();
                    recording = false;
                    updateBtnUI(false);
                }

                currentServerScores = data.current_scores;
                if (isLiveMode()) {
                    updateScoreboard(currentServerScores);
                }
            } catch (e) { }
        }

        async function fetchHistory() {
            if (!recording) return;
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                eventHistory = data.events;
                startTime = data.start_time;
            } catch (e) { }
        }

        function isLiveMode() {
            if (!recording) return true;
            if (video.paused) return false;
            return (video.duration - video.currentTime) < 6.0;
        }

        video.addEventListener('timeupdate', () => {
            if (!recording || eventHistory.length === 0) return;

            const live = isLiveMode();
            updateBadges(live);
            if (live) return;

            const vTime = video.currentTime;
            let foundScores = null;

            for (let i = eventHistory.length - 1; i >= 0; i--) {
                const eventRelativeTime = eventHistory[i].timestamp - startTime;
                if (eventRelativeTime <= vTime) {
                    foundScores = eventHistory[i].scores;
                    break;
                }
            }

            if (foundScores) {
                updateScoreboard(foundScores);
            } else if (eventHistory.length > 0) {
                updateScoreboard(eventHistory[0].scores);
            }
        });

        async function updateScore(playerId, action) {
            const el = document.getElementById(`disp-${playerId}`);
            if (!el) return;

            let val = parseInt(el.innerText);
            if (action === 'add') val++;
            if (action === 'subtract' && val > 0) val--;
            el.innerText = val;

            try {
                const res = await fetch('/update_score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player: playerId, action })
                });
                const data = await res.json();
                currentServerScores = data.scores;
                if (isLiveMode()) {
                    updateScoreboard(currentServerScores);
                }
            } catch (e) { console.error(e); }
        }

        async function resetScores() {
            if (!confirm("¬øResetear a 0?")) return;
            await fetch('/reset_scores', { method: 'POST' });
        }

        async function toggleRecording() {
            if (recording) {
                if (!confirm("¬øParar grabaci√≥n?")) return;
                await fetch('/stop_recording', { method: 'POST' });
                stopPlayerUI();
            } else {
                updateStatusMsg("Iniciando FFmpeg...");
                await fetch('/start_recording', { method: 'POST' });
            }
        }

        function startPlayerUI() {
            document.getElementById('noSignal').classList.add('hidden');
            hls.loadSource(hlsSource);
            hls.startLoad();
            video.muted = true;
            video.play().catch(e => log("Autoplay blocked: " + e));
        }

        function stopPlayerUI() {
            document.getElementById('noSignal').classList.remove('hidden');
            updateStatusMsg("Listo");
            if (hls) hls.stopLoad();
            document.getElementById('badgeLive').classList.add('hidden');
            document.getElementById('badgeDVR').classList.add('hidden');
        }

        function goLive() {
            if (recording) {
                video.currentTime = video.duration - 0.5;
                video.play();
            }
        }

        function updateScoreboard(scores) {
            for (const [k, v] of Object.entries(scores)) {
                const el = document.getElementById(`disp-${k}`);
                if (el) el.innerText = v;
            }
        }

        function updateBtnUI(isRec) {
            const btn = document.getElementById('btnRecord');
            if (isRec) {
                btn.innerText = "Detener";
                btn.className = "btn-main btn-golive";
            } else {
                btn.innerText = "Grabar";
                btn.className = "btn-main btn-record";
            }
        }

        function updateBadges(isLive) {
            const bLive = document.getElementById('badgeLive');
            const bDVR = document.getElementById('badgeDVR');
            if (isLive) {
                bLive.classList.remove('hidden');
                bDVR.classList.add('hidden');
            } else {
                bLive.classList.add('hidden');
                bDVR.classList.remove('hidden');
            }
        }

        function updateStatusMsg(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        // Initialize setup on load
        document.addEventListener('DOMContentLoaded', () => {
            generatePlayerInputs();
        });
    </script>
</body>

</html>